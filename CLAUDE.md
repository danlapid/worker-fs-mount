# CLAUDE.md

This file provides guidance to Claude Code when working with this repository.

## Project Overview

**@cloudflare/worker-fs-mount** is an npm package that allows Cloudflare Workers to mount WorkerEntrypoints as virtual filesystems. It works by monkey-patching `node:fs/promises` to intercept filesystem calls and redirect mounted paths to WorkerEntrypoint implementations via jsrpc.

### Key Concept

Users call `mount('/mnt/path', stub)` where `stub` is a WorkerEntrypoint (from `ctx.exports`, `env.SERVICE`, or a Durable Object stub). After mounting, any `node:fs/promises` operation targeting that path is forwarded to the stub's methods.

```typescript
import { mount } from '@cloudflare/worker-fs-mount';
import fs from 'node:fs/promises';

mount('/mnt/storage', env.STORAGE_SERVICE);
await fs.readFile('/mnt/storage/file.txt');  // → calls env.STORAGE_SERVICE.readFile('/file.txt')
```

## Project Structure

```
worker-fs-mount/
├── src/
│   ├── index.ts      # Entry point - imports patch.ts for side effects, exports public API
│   ├── types.ts      # TypeScript interfaces (WorkerFilesystem, Stat, DirEntry, MountHandle)
│   ├── registry.ts   # Mount registry - mount(), findMount(), isMounted(), getMounts()
│   └── patch.ts      # Monkey-patches node:fs/promises methods
├── dist/             # Compiled output (generated by `npm run build`)
├── package.json      # ESM package configuration
├── tsconfig.json     # Strict TypeScript configuration
├── SPEC.md           # Full specification document
└── README.md         # User documentation
```

## Build & Development Commands

```bash
npm install          # Install dependencies
npm run build        # Compile TypeScript to dist/
npm run dev          # Watch mode compilation
npm run typecheck    # Type check without emitting
npm run clean        # Remove dist/
```

## Architecture

### How Monkey-Patching Works

1. **`patch.ts`** imports `node:fs/promises` and stores references to all original methods
2. It replaces each method with a wrapper that:
   - Extracts the path from arguments
   - Calls `findMount(path)` to check if path is under a mount
   - If mounted: calls the stub's method via jsrpc and returns the result
   - If not mounted: calls the original `node:fs/promises` method
3. **`index.ts`** imports `patch.ts` for its side effects, so patching happens on first import

### Mount Registry (`registry.ts`)

- `mounts`: `Map<string, Mount>` - stores active mounts keyed by normalized path
- `mount(path, stub)`: validates path, checks for conflicts, adds to registry
- `findMount(path)`: iterates mounts to find longest matching prefix
- `normalizePath(path)`: removes trailing slashes, collapses multiple slashes

### Type System (`types.ts`)

- **`WorkerFilesystem`**: interface that mounted stubs must implement
  - Required: `stat`, `readFile`, `writeFile`, `readdir`, `mkdir`, `rm`, `unlink`
  - Optional: `read`, `write`, `createReadStream`, `createWriteStream`, `truncate`, `rename`, `cp`, `symlink`, `readlink`, `access`, `setLastModified`
- **`Stat`**: `{ type: 'file'|'directory'|'symlink', size: number, lastModified?: Date, ... }`
- **`DirEntry`**: `{ name: string, type: 'file'|'directory'|'symlink' }`
- **`MountHandle`**: returned by `mount()`, has `path` and `unmount()`

## Key Implementation Details

### Path Handling

- All mount paths must be absolute (start with `/`)
- Paths are normalized: trailing slashes removed, multiple slashes collapsed
- Reserved paths (`/bundle`, `/tmp`, `/dev`) cannot be mounted over
- Nested mounts are not allowed (can't mount `/a/b` if `/a` is mounted)

### Type Conversions

- `toNodeStats(Stat)`: converts our Stat to Node.js Stats object with all required methods (`isFile()`, `isDirectory()`, etc.)
- `toNodeDirent(DirEntry)`: converts our DirEntry to Node.js Dirent object
- `createFsError(code, syscall, path)`: creates Node.js-style errors with `.code`, `.syscall`, `.path`

### Cross-Mount Operations

- `rename`: throws `EXDEV` if source and dest are on different mounts
- `copyFile`/`cp`: works across mounts by reading from source and writing to dest
- Directory copy across mounts is not yet implemented (throws `EISDIR`)

## Testing Considerations

When writing tests:

1. Use `clearMounts()` in `beforeEach`/`afterEach` to reset state
2. Create mock WorkerFilesystem implementations that track calls
3. Test both mounted and non-mounted paths to ensure fallback works
4. Test error cases: ENOENT, EXDEV, ENOSYS
5. Test path edge cases: trailing slashes, double slashes, mount root vs subdirectory

Example test structure:
```typescript
import { mount, clearMounts } from '@cloudflare/worker-fs-mount';
import fs from 'node:fs/promises';

const mockFs = {
  readFile: async (path) => new TextEncoder().encode('test'),
  stat: async (path) => ({ type: 'file', size: 4 }),
  // ... other required methods
};

beforeEach(() => clearMounts());

test('readFile on mounted path calls stub', async () => {
  mount('/mnt/test', mockFs);
  const content = await fs.readFile('/mnt/test/file.txt', 'utf8');
  expect(content).toBe('test');
});
```

## Common Development Tasks

### Adding a New fs Method

1. Add the method signature to `originals` object in `patch.ts`
2. Implement the patched version following the pattern:
   ```typescript
   fs['methodName'] = async function methodName(...args) {
     const pathStr = getPath(args[0]);
     if (pathStr) {
       const match = findMount(pathStr);
       if (match) {
         // Call stub method, convert types as needed
         return match.mount.stub.methodName(match.relativePath, ...);
       }
     }
     return originals.methodName(...args);
   };
   ```
3. Add corresponding method to `WorkerFilesystem` interface in `types.ts`
4. Update README.md with the new method

### Adding a New Export

1. Add to `src/index.ts` exports
2. Run `npm run build` to regenerate `.d.ts` files
3. Update README.md API Reference section

## Dependencies

- **@cloudflare/workers-types**: Type definitions for Cloudflare Workers runtime
- **@types/node**: Node.js type definitions (for fs types)
- **typescript**: TypeScript compiler

The package has no runtime dependencies - it only uses `node:fs/promises` and `node:buffer` which are available in the Workers runtime.

## Future Work (from SPEC.md)

1. **Patch sync fs functions** - Make `node:fs` sync methods throw clear errors on mounted paths
2. **Watch API** - Support `fs.watch()` via event streams over jsrpc
3. **Caching layer** - Optional caching for remote filesystems
4. **Partial interface detection** - Runtime detection of which methods a stub supports

## Related Documentation

- **SPEC.md**: Full specification with rationale, design decisions, and implementation details
- **README.md**: User-facing documentation with examples
- **workerd**: The Cloudflare Workers runtime - see `/Users/danlapid/Cloudflare/workerd/` for the runtime implementation

## Coding Standards

- TypeScript strict mode enabled
- ESM modules only (`"type": "module"` in package.json)
- Use `.js` extensions in imports (required for ESM)
- Follow Node.js fs error conventions (use `createFsError()`)
- All async methods should handle both mounted and non-mounted paths
